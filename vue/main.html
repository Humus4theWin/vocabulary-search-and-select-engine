<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

<div id="app">
    <h1>Frontend Search</h1>
    <div>
        <div v-for="vocab in vocabs">
            <div v-bind:class="vocab.data!=='' ? 'loaded':''">
                {{ vocab.url }}
            </div>
        </div>
    </div>
    </button>
</div>


<script>
 var app = new Vue({
        el: '#app',
        data: {
            vocabs:[
                {
                    url: "",
                    data: "",
                    type: "",
                }
            ]
        },
        // load all vocabs
        async created (){
            let vocabList =  await fetch('/vocabs').then(data => data.json())
            this.vocabs = vocabList.map(url => {
                return {
                    url: url,
                    data: "",
                    type: "",
                }
            })
            // load all vocabs
            await this.getAllVocabs(this.vocabs, this.getVocabDirect)
            // load missing ones
            await this.getAllVocabs(this.vocabs.filter(v => !v.loaded), this.getVocabProxy)
        },
        watch:{
            vocabs:function(val){
                console.log(val)
             },
             
        },
        methods: {
            getAllVocabs(vocabList, loadFunction){
                let promises = vocabList.map(vocab => {
                    loadFunction(vocab)       
                });
                return Promise.all(promises)
            },
            getVocabDirect(vocab){
                return fetch(vocab.url)
                .then(data => {
                    vocab.type = data.headers.get("content-type")
                    return data.text()
                })
                .then(text => {
                    vocab.data = text
                })
                .catch(err =>  console.log("error CORS?"))   //make second request sync
            },
            getVocabProxy(vocab){
                return fetch('/proxy',{
                  //  method:"PUT",
                    headers: {'url': vocab.url},
                   // body: vocabPath
                })
                .then(data => {
                    vocab.type = data.headers.get("content-type")
                    return data.text()
                })
                .then(text => {
                    vocab.data = text
                })
                .catch(err => console.log(err))
            },
        }
    })
</script>

<style>
.loaded{
    background-color: lightgreen;
}




</style>